<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- يجب أن يكون العنوان ديناميكيًا من الخادم -->
    <title>{{ chat.title | default('محادثة جديدة') }} - DzTeck.ai</title>
    <meta name="description" content="DzTeck.ai - واجهة محادثة ذكية تعمل بالذكاء الاصطناعي بواسطة OpenRouter">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- *** تأكد من ربط ملف CSS الموحد والصحيح *** -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="chat-container">
        <header class="chat-header">
            <div class="logo">
                <a href="{{ url_for('index') }}" class="back-button">
                    <!-- تأكد من أن مسار الأيقونة صحيح أو استخدم Font Awesome -->
                    <img src="{{ url_for('static', filename='img/back-icon.svg') }}" alt="رجوع" class="back-icon" onerror="this.style.display='none'; this.onerror=null;">
                    <!-- بديل Font Awesome إذا لم تعمل الصورة -->
                    <!-- <i class="fas fa-arrow-right back-icon"></i> -->
                </a>
                <img src="{{ url_for('static', filename='img/logo.svg') }}" alt="DzTeck Logo" class="logo-img">
            </div>
            <div class="header-content">
                <!-- العنوان يمكن أن يكون عنوان المحادثة -->
                <h1 class="site-name">{{ chat.title | default('DzTeck.ai') }}</h1>
                <span class="creator-info">نموذج: {{ chat.model | default('غير محدد') }}</span>
            </div>
        </header>

        <!-- منطقة عرض الرسائل -->
        <div class="chat-box" id="chat-box">
            <!-- رسالة ترحيب أولية (إذا كانت المحادثة جديدة) -->
            {% if not messages %}
             <div class="message bot-message">
                <div class="message-icon">
                    <img src="{{ url_for('static', filename='img/bot-icon.svg') }}" alt="Bot">
                </div>
                <div class="message-content">
                    مرحباً بك في DzTeck! كيف يمكنني مساعدتك اليوم؟
                </div>
            </div>
            {% endif %}

            <!-- عرض الرسائل المحفوظة من الخادم -->
            {% for message in messages %}
                {# --- تأكد من أن message.id متاح من الخادم --- #}
                <div class="message {{ 'user-message' if message.role == 'user' else 'bot-message' }}" data-message-id="{{ message.id | default('unknown_id_' + loop.index|string) }}">
                    <div class="message-icon">
                        <img src="{{ url_for('static', filename='img/user-icon.svg' if message.role == 'user' else 'img/bot-icon.svg') }}" alt="{{ message.role }}">
                    </div>
                    <div class="message-content">
                        {# استخدم safe إذا كان المحتوى يتضمن HTML/Markdown تم تحويله بأمان #}
                        {{ message.content | safe }}

                        {# --- إضافة زر الحذف لرسائل المستخدم فقط --- #}
                        {% if message.role == 'user' %}
                        <button class="delete-msg-btn" title="حذف الرسالة" data-msg-id="{{ message.id | default('unknown_id_' + loop.index|string) }}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        {% endif %}
                        {# --- نهاية زر الحذف --- #}
                    </div>
                </div>
            {% endfor %}
            <!-- سيتم إضافة الرسائل الجديدة هنا بواسطة JavaScript -->
        </div>
        <!-- نهاية منطقة عرض الرسائل -->

        <!-- منطقة الإدخال ومفتاح API -->
        <div class="input-section">
            <div class="input-area">
                <input type="text" id="user-input" placeholder="اكتب رسالتك هنا..." autocomplete="off">
                <button id="send-button" title="إرسال">
                    <!-- تأكد من وجود الأيقونة أو استخدم Font Awesome -->
                    <img src="{{ url_for('static', filename='img/send-icon.svg') }}" alt="إرسال" onerror="this.style.display='none'; this.onerror=null;">
                    <!-- <i class="fas fa-paper-plane"></i> -->
                </button>
            </div>
            <div class="api-key-area">
                <label for="api-key">مفتاح OpenRouter:</label>
                <input type="password" id="api-key" placeholder="أدخل مفتاح API الخاص بك">
                <button id="toggle-api-key" title="إظهار/إخفاء المفتاح">
                    <img src="{{ url_for('static', filename='img/eye-icon.svg') }}" alt="Toggle Visibility" onerror="this.style.display='none'; this.onerror=null;">
                    <!-- <i class="fas fa-eye"></i> -->
                </button>
            </div>
        </div>
        <!-- نهاية منطقة الإدخال -->

        <footer class="chat-footer">
            <p>DzTeck.ai © 2025</p>
            <p class="footer-tagline">واجهة محادثة عربية متقدمة</p>
        </footer>

        <!-- Hidden Fields (تأكد من تمرير هذه القيم من الخادم) -->
        <input type="hidden" id="chat-id" value="{{ chat.id | default('new') }}">
        <input type="hidden" id="model-name" value="{{ chat.model | default('mistralai/mistral-7b-instruct-v0.2') }}">
    </div>

    <!-- *** ربط ملف JavaScript الخاص بالدردشة والذي يحتوي الآن على منطق الحذف *** -->
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>
</html>
